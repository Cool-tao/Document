### 一次完整的网络请求过程  
◆ 概述    
◑ 域名解析；  
◑ TCP的三次握手；  
◑ 建立TCP连接后发起HTTP请求；  
◑ 客户端解析ResponseBody；  

Http连接实际上就是TCP连接，和一些使用TCP连接的规则；  
◑ 解析出主机名；  
◑ 查询这个主机名对应的IP地址；  
◑ 获取端口号；  
◑ 发送连接到对应的 主机 : 端口；  
◑ 发送GET等请求；  
◑ 收到服务端的响应报文；  
◑ 关闭连接；  
[图例](../../ImageFiles/http_008.png)  
 ◆ 多条连接如何区分？  
 每条TCP连接都会包含<源IP地址、源端口号、目的IP地址、目的端口号>  

[Http - Https 协议栈](../../ImageFiles/http_001.png)  
[Http - TCP 数据包](../../ImageFiles/http_002.png)  
[TCP连接所需要的套接字函数](../../ImageFiles/http_003.png)  
[TCP连接，客户端 与 服务端 交互](../../ImageFiles/http_004.png)  
◆ HTTP 通信传输流  
[HTTP请求与响应](../../ImageFiles/http_005.png)  
发送端在层与层之间传输数据时，每经过一层时必定会被打上一个该层所属的首部信息。   
反之，接收端在层与层传输数据时，每经过一层时会把对应的首部消去。  

与HTTP协议密切相关的协议：  IP、 TCP、 DNS  
◆ 各种协议与 HTTP 协议的关系  
[关系图](../../ImageFiles/http_007.png)  
◆ 关于Http连接的问题
◑ 每进行一次 HTTP 通信就要断开一次TCP 连接  
[断开TCP 连接](../../ImageFiles/http_009.png)  
◑ 持久连接  
为解决上述 TCP 连接的问题， HTTP/1.1 和一部分的 HTTP/1.0 想出了持久连接（HTTP Persistent Connections，也称为 HTTP keep-alive 或HTTP connection reuse）的方法。  
持久连接的特点是，只要任意一端没有明确提出断开连接，则保持 TCP 连接状态。  
[保持TCP 连接](../../ImageFiles/http_010.png)  
持久连接的好处在于减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。  
另外，减少开销的那部分时间，使HTTP 请求和响应能够更早地结束， 这样 Web 页面的显示速度也就相应提高了。  
◑ 管线化  
持久连接使得多数请求以管线化（pipelining）方式发送成为可能。从前发送请求后需等待并收到响应， 才能发送下一个请求。  
管线化技术出现后，不用等待响应亦可直接发送下一个请求。这样就能够做到同时并行发送多个请求， 而不需要一个接一个地等待响应了。  
比如，当请求一个包含 10 张图片的 HTML Web 页面，与挨个连接相比，用持久连接可以让请求更快结束。而管线化技术则比持久连接还要快。  
请求数越多，时间差就越明显。  
[管线化](../../ImageFiles/http_011.png)  

◆ 使用 Cookie 的状态管理  
HTTP 是无状态协议，它不对之前发生过的请求和响应的状态进行管理。也就是说，无法根据之前的状态进行本次的请求处理。  
不可否认，无状态协议当然也有它的优点。由于不必保存状态，自然可减少服务器的 CPU 及内存资源的消耗。  
从另一侧面来说，也正是因为 HTTP 协议本身是非常简单的，所以才会被应用在各种场景里。  
保留无状态协议这个特征的同时又要解决类似的矛盾问题，于是引入了 Cookie 技术。 Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。  
Cookie 会根据从服务器端发送的响应报文内的一个叫做 Set-Cookie的首部字段信息， 通知客户端保存 Cookie。  
当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送出去。  
服务器端发现客户端发送过来的 Cookie 后， 会去检查究竟是从哪一个客户端发来的连接请求， 然后对比服务器上的记录，最后得到之前的状态信息。  

◑ 响应报文（服务器端生成 Cookie 信息）  
```
HTTP/1.1 200 OK
Date: Thu, 12 Jul 2012 07:12:20 GMT
Server: Apache
＜Set-Cookie: sid=1342077140226724; path=/; expires=Wed,
10-Oct-12 07:12:20 GMT＞
Content-Type: text/plain; charset=UTF-8
```
◑ 请求报文（自动发送保存着的 Cookie 信息）  
```
GET /image/ HTTP/1.1
Host: hackr.jp
Cookie: sid=1342077140226724
```
